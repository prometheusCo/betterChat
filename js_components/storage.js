//
// set

//
//
// Components vars
//
//


let chatHistory = [];

// 
//
// Storage saving functions
//


//
// Cnryption/decryption fnc
//

function getEncryptionSecret() {
    function _0x281c0a(_0xd2ce60, _0x5904f2, _0x40bacc, _0x1bbbe4, _0x21fcf3) { return _0x44cf(_0x5904f2 - 0x349, _0x40bacc); } function _0x1011() { var _0x4ea481 = ['W4/dSwnBDSkdW50SW7ddKI7cUJq', 'q8klW4emFG', 'mYaLW5Tu', 'WODpW6b8rmk6W7DJWQi', 'cZRcSmoVW5S', 'zmkEWPXeCg0oWOO', 'W54Yw8o3srRdJ8kuoSoqWP3dLCk2', 'cSoSk8kJW4O', 'WPNdLmkYgCoV', 'W4RcG8kYhSoGr0/dUfapfmk6ga', 'W5dcSu5GW6W', 'a8okW4DvocZcMtHwqCk2WOVdLHe', 'pmkurmokkW', 'cgW0W7pdKeTlW4NcGq', 'nmkBW4JdHetcJsfKW4ZdP3KE', 'WR5yW6hcISoO', 'CGvFW7ddUcNdGeFdPmkLWO0', 'FIVdIaz3WOSnWORcRabH', 'WPNdTvfKDW', 'emkQsaxcQCkjW79XW5RcGG', 'W5GDhSkRmG', 'EaXCW7BdV0JcGMhdKCkiWRXFmG', 'emopx29e', 'xmk0kCoLWOGHxSoEBbNdSCoZW4u', 'mce2WOu8', 'WPamW4vlW6pdMCoUWRu3bmolW4XA', 'W4BdTZLHWPvjemoH', 'W5VcPqeXsfVdRJZdGZK', 'qmo5W5hdSwW9WPVdJ8k8j2ddVq', 'DWyPWPHp', 'WRTEW7ddNSoW', 'W4lcU0SahNXRWQW2W6HKsCoGW50']; _0x1011 = function () { return _0x4ea481; }; return _0x1011(); } (function (_0x7a06d, _0x76ad6f) { function _0x47370e(_0x5ae558, _0x569e49, _0x2eafb3, _0x4c5e4a, _0x3b6e92) { return _0x44cf(_0x3b6e92 - -0x2c, _0x5ae558); } function _0x188519(_0x5020fb, _0x3c5ae2, _0x3ac158, _0x26bf9f, _0x2a9280) { return _0x44cf(_0x5020fb - -0x3a3, _0x3c5ae2); } function _0x21eb3f(_0x243cb2, _0x1ee795, _0x8d1d7f, _0x5a7dc8, _0x3af4be) { return _0x44cf(_0x5a7dc8 - -0x2b1, _0x1ee795); } function _0x4509f6(_0x503934, _0x3c4086, _0x4ccdf0, _0x462aa3, _0x24235e) { return _0x44cf(_0x3c4086 - -0x1e5, _0x462aa3); } function _0x14acfe(_0x918592, _0x5ccd0e, _0x3a2118, _0x32ba89, _0xf4127a) { return _0x44cf(_0x918592 - 0x12, _0x3a2118); } var _0x239375 = _0x7a06d(); while (!![]) { try { var _0x4af0d8 = parseInt(_0x47370e('z%u4', 0x1b3, 0x1c3, 0x1c0, 0x1b8)) / (0x97d + -0xd6 * 0x1 + -0x6 * 0x171) * (-parseInt(_0x47370e('K!%l', 0x1c8, 0x1d7, 0x1e1, 0x1d2)) / (0x1 * -0x13d + -0x1924 + -0x3c5 * -0x7)) + -parseInt(_0x47370e('41dV', 0x1a6, 0x1ab, 0x1ad, 0x1b6)) / (0xf03 + 0x110f * 0x1 + -0x11b * 0x1d) + -parseInt(_0x14acfe(0x1fc, 0x1f6, 'wdk5', 0x1ef, 0x203)) / (-0x22cd + -0x69d + 0x296e) + -parseInt(_0x14acfe(0x20c, 0x202, 'BQbh', 0x210, 0x205)) / (-0x62 * 0x23 + -0x22dd + -0x4 * -0xc12) + parseInt(_0x188519(-0x1bb, '0J)Y', -0x1ca, -0x1c2, -0x1ab)) / (0xa4f + 0x167 * 0x5 + -0x2 * 0x8a6) + parseInt(_0x4509f6(0x10, 0x6, 0x4, '5YeJ', 0x9)) / (0x1b4d + 0x5 * -0x1 + -0x1b41) * (-parseInt(_0x47370e('UH4R', 0x1b1, 0x1bf, 0x1c9, 0x1c1)) / (-0xc31 + -0x2e9 + 0xf22)) + parseInt(_0x4509f6(0x19, 0xb, 0xa, 'OyE8', 0x17)) / (-0x7 * 0x44b + -0x168a + 0x34a0); if (_0x4af0d8 === _0x76ad6f) break; else _0x239375['push'](_0x239375['shift']()); } catch (_0x219eeb) { _0x239375['push'](_0x239375['shift']()); } } }(_0x1011, -0x7d10b + 0x41105 * -0x1 + -0x35cc6 * -0x5)); function _0x2bd142(_0x31d2c5, _0x59b119, _0x276894, _0x5689dd, _0x5dfb6b) { return _0x44cf(_0x5689dd - -0x2ef, _0x31d2c5); } function _0x3e19a5(_0x13a896, _0x1201a5, _0x431d5d, _0x25807f, _0x325ea8) { return _0x44cf(_0x325ea8 - 0x151, _0x13a896); } function _0x44cf(_0x54a59c, _0x31c9a1) { _0x54a59c = _0x54a59c - (0x1d8f + 0x987 * 0x2 + -0x2ebe); var _0x34dfa4 = _0x1011(); var _0x4278bc = _0x34dfa4[_0x54a59c]; if (_0x44cf['KywRKs'] === undefined) { var _0x2cd8b4 = function (_0x4fc6de) { var _0x1a2e8d = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/='; var _0x15ed0b = '', _0xb26ad1 = ''; for (var _0x50dfd0 = 0x3 * -0x9b + 0xe9e + -0xccd, _0x229fa, _0x590097, _0xf2e855 = -0x19f + -0x37 * 0xaf + 0x1f6 * 0x14; _0x590097 = _0x4fc6de['charAt'](_0xf2e855++); ~_0x590097 && (_0x229fa = _0x50dfd0 % (-0x1cfb + -0x1acc + 0x1b * 0x211) ? _0x229fa * (-0x99b * 0x3 + 0x4 * 0x8b6 + -0x5c7) + _0x590097 : _0x590097, _0x50dfd0++ % (-0x705 * -0x4 + 0x6fa * 0x4 + -0x9 * 0x638)) ? _0x15ed0b += String['fromCharCode'](0xdc1 + 0x8b * 0x20 + -0xe * 0x227 & _0x229fa >> (-(-0x94d * -0x1 + 0x1747 * -0x1 + 0xdfc) * _0x50dfd0 & -0x1db1 + 0x1b27 + -0x8 * -0x52)) : -0x192d + 0x10f6 + 0x1 * 0x837) { _0x590097 = _0x1a2e8d['indexOf'](_0x590097); } for (var _0x57ed16 = 0x18ad * 0x1 + 0x13c6 + 0x1 * -0x2c73, _0x7368ce = _0x15ed0b['length']; _0x57ed16 < _0x7368ce; _0x57ed16++) { _0xb26ad1 += '%' + ('00' + _0x15ed0b['charCodeAt'](_0x57ed16)['toString'](0xb * 0x2e4 + 0x25 * 0x27 + 0x3 * -0xc75))['slice'](-(-0xd6 * 0x1 + -0x1 * 0x541 + 0x619)); } return decodeURIComponent(_0xb26ad1); }; var _0x2695de = function (_0x139859, _0x3eabe3) { var _0x1de2f7 = [], _0x29fa9c = -0x1924 * 0x1 + -0x9a9 * -0x1 + 0x3 * 0x529, _0x84fb93, _0x3ca566 = ''; _0x139859 = _0x2cd8b4(_0x139859); var _0x3ca3a5; for (_0x3ca3a5 = 0x1a * -0x4e + 0xe92 + -0x6a6; _0x3ca3a5 < -0x69d + -0x1ba4 + 0x2341; _0x3ca3a5++) { _0x1de2f7[_0x3ca3a5] = _0x3ca3a5; } for (_0x3ca3a5 = -0x22dd + 0x18d + -0x4 * -0x854; _0x3ca3a5 < 0xa4f + 0x167 * 0x5 + -0x1 * 0x1052; _0x3ca3a5++) { _0x29fa9c = (_0x29fa9c + _0x1de2f7[_0x3ca3a5] + _0x3eabe3['charCodeAt'](_0x3ca3a5 % _0x3eabe3['length'])) % (0x1b4d + 0x5 * -0x1 + -0x1a48), _0x84fb93 = _0x1de2f7[_0x3ca3a5], _0x1de2f7[_0x3ca3a5] = _0x1de2f7[_0x29fa9c], _0x1de2f7[_0x29fa9c] = _0x84fb93; } _0x3ca3a5 = -0xc31 + -0x2e9 + 0xf1a, _0x29fa9c = -0x7 * 0x44b + -0x168a + 0x3497; for (var _0x4a729d = -0x1efa + 0x55f * -0x3 + -0x2f17 * -0x1; _0x4a729d < _0x139859['length']; _0x4a729d++) { _0x3ca3a5 = (_0x3ca3a5 + (-0x26af + -0x1 * 0x20ff + -0x47af * -0x1)) % (-0x18ba + -0xd * 0x2f5 + 0x402b), _0x29fa9c = (_0x29fa9c + _0x1de2f7[_0x3ca3a5]) % (0x1b4d + 0x7a3 * 0x4 + -0x38d9), _0x84fb93 = _0x1de2f7[_0x3ca3a5], _0x1de2f7[_0x3ca3a5] = _0x1de2f7[_0x29fa9c], _0x1de2f7[_0x29fa9c] = _0x84fb93, _0x3ca566 += String['fromCharCode'](_0x139859['charCodeAt'](_0x4a729d) ^ _0x1de2f7[(_0x1de2f7[_0x3ca3a5] + _0x1de2f7[_0x29fa9c]) % (-0x64 * -0x35 + 0x1c * 0x31 + -0x1910)]); } return _0x3ca566; }; _0x44cf['nrXcyo'] = _0x2695de, _0x44cf['zwMztx'] = {}, _0x44cf['KywRKs'] = !![]; } var _0x24fe05 = _0x34dfa4[-0x1 * 0x1714 + -0x2 * -0xeed + -0x6c6], _0x29ad86 = _0x54a59c + _0x24fe05, _0x5bdcbc = _0x44cf['zwMztx'][_0x29ad86]; return !_0x5bdcbc ? (_0x44cf['dxPFhS'] === undefined && (_0x44cf['dxPFhS'] = !![]), _0x4278bc = _0x44cf['nrXcyo'](_0x4278bc, _0x31c9a1), _0x44cf['zwMztx'][_0x29ad86] = _0x4278bc) : _0x4278bc = _0x5bdcbc, _0x4278bc; } function _0x467f68(_0x3f9851, _0x239e77, _0x28318a, _0x41d60c, _0x12aa29) { return _0x44cf(_0x239e77 - -0x3bf, _0x41d60c); } function _0x4b6657(_0x14fc8e, _0x286705, _0x3224fe, _0x21c5a5, _0x939179) { return _0x44cf(_0x14fc8e - 0x328, _0x21c5a5); } return _0x2bd142('[aNT', -0xf5, -0xe4, -0xf4, -0x101) + _0x2bd142('kSkz', -0x110, -0x100, -0x100, -0xfb) + _0x467f68(-0x1dc, -0x1da, -0x1cf, '1AVm', -0x1e4) + _0x467f68(-0x1d4, -0x1cd, -0x1c9, 'ytdk', -0x1da) + _0x467f68(-0x1c1, -0x1ca, -0x1da, '^$Go', -0x1cb) + _0x281c0a(0x530, 0x530, 'D%Lx', 0x528, 0x52b) + _0x467f68(-0x1e3, -0x1dc, -0x1d2, '6@DE', -0x1eb) + _0x2bd142('#m^y', -0xf8, -0x10e, -0x101, -0xff) + _0x281c0a(0x556, 0x546, 'YvAt', 0x54a, 0x54f) + _0x2bd142('F4wq', -0x103, -0x10c, -0x106, -0xfd) + _0x281c0a(0x539, 0x53c, 'pa(v', 0x539, 0x53f) + _0x3e19a5('BQbh', 0x354, 0x340, 0x35a, 0x34a) + _0x2bd142('kSkz', -0x11b, -0x10c, -0x10f, -0x10d) + _0x3e19a5('0J)Y', 0x356, 0x350, 0x33e, 0x349) + 'a';
}


async function encrypt(text) {

    const enc = new TextEncoder();

    const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(getEncryptionSecret()),
        "PBKDF2",
        false,
        ["deriveKey"]
    );

    const key = await crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt: enc.encode("salt"),
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt"]
    );

    const iv = crypto.getRandomValues(new Uint8Array(12));

    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(text)
    );

    // iv + ciphertext → base64 string
    const buffer = new Uint8Array([...iv, ...new Uint8Array(encrypted)]);
    return btoa(String.fromCharCode(...buffer));
}

async function decrypt(cipherText) {

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    // base64 → bytes
    const raw = Uint8Array.from(atob(cipherText), c => c.charCodeAt(0));

    // extract IV (first 12 bytes) + encrypted data
    const iv = raw.slice(0, 12);
    const data = raw.slice(12);

    const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(getEncryptionSecret()),
        "PBKDF2",
        false,
        ["deriveKey"]
    );

    const key = await crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt: enc.encode("salt"),
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
    );

    const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        key,
        data
    );

    return dec.decode(decrypted);
}

//
// Encrypt/Decrypt end
//


function saveMessage(content, role, actions = false, resume = false) {

    let el = false;

    try {
        el = document.querySelectorAll(`.user_message`)[document.querySelectorAll(`.user_message`).length - 1]
    } catch (error) { };


    if (role === "assistant" && el.querySelectorAll(".chat_actions").length > 0) {
        actions = true;
        resume = chat_resume.at(-1)[0];
    }

    chatHistory.push({ content, role, actions, resume });
    saveStorage('chat_history', JSON.stringify(chatHistory));

}

async function saveStorage(keyName, keyValue) {

    const encryptedValue = await encrypt(keyValue);
    localStorage.setItem(keyName, encryptedValue);

}

async function loadFromStorage(keyName) {

    const encryptedValue = localStorage.getItem(keyName);
    if (!encryptedValue) return null;

    return await decrypt(encryptedValue);

}

function clearHistory() {

    localStorage.removeItem('chat_history');
    localStorage.removeItem('chat_resume');
}


